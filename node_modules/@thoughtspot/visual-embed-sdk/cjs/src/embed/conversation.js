"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConversationEmbed = exports.SpotterEmbed = void 0;
const tslib_1 = require("tslib");
const isUndefined_1 = tslib_1.__importDefault(require("lodash/isUndefined"));
const errors_1 = require("../errors");
const types_1 = require("../types");
const ts_embed_1 = require("./ts-embed");
const utils_1 = require("../utils");
/**
 * Embed ThoughtSpot AI Conversation.
 * @group Embed components
 * @example
 * ```js
 * const conversation = new SpotterEmbed('#tsEmbed', {
 *   worksheetId: 'worksheetId',
 *   searchOptions: {
 *     searchQuery: 'searchQuery',
 *   },
 * });
 * conversation.render();
 * ```
 * @version SDK: 1.37.0 | ThoughtSpot: 10.9.0.cl
 */
class SpotterEmbed extends ts_embed_1.TsEmbed {
    constructor(container, viewConfig) {
        viewConfig = {
            embedComponentType: 'conversation',
            excludeRuntimeFiltersfromURL: true,
            excludeRuntimeParametersfromURL: true,
            ...viewConfig,
        };
        super(container, viewConfig);
        this.viewConfig = viewConfig;
    }
    getEmbedParamsObject() {
        const { worksheetId, searchOptions, disableSourceSelection, hideSourceSelection, dataPanelV2, showSpotterLimitations, hideSampleQuestions, runtimeFilters, excludeRuntimeFiltersfromURL, runtimeParameters, excludeRuntimeParametersfromURL, updatedSpotterChatPrompt, spotterSidebarConfig, spotterChatConfig, } = this.viewConfig;
        // Extract sidebar config properties
        const { enablePastConversationsSidebar, spotterSidebarTitle, spotterSidebarDefaultExpanded, spotterChatRenameLabel, spotterChatDeleteLabel, spotterDeleteConversationModalTitle, spotterPastConversationAlertMessage, spotterDocumentationUrl, spotterBestPracticesLabel, spotterConversationsBatchSize, spotterNewChatButtonTitle, } = spotterSidebarConfig || {};
        if (!worksheetId) {
            this.handleError({
                errorType: types_1.ErrorDetailsTypes.VALIDATION_ERROR,
                message: errors_1.ERROR_MESSAGE.SPOTTER_EMBED_WORKSHEED_ID_NOT_FOUND,
                code: types_1.EmbedErrorCodes.WORKSHEET_ID_NOT_FOUND,
                error: errors_1.ERROR_MESSAGE.SPOTTER_EMBED_WORKSHEED_ID_NOT_FOUND,
            });
        }
        const queryParams = this.getBaseQueryParams();
        queryParams[types_1.Param.SpotterEnabled] = true;
        // Boolean params
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.DisableSourceSelection, disableSourceSelection, true);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.HideSourceSelection, hideSourceSelection, true);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.DataPanelV2Enabled, dataPanelV2, true);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.ShowSpotterLimitations, showSpotterLimitations, true);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.HideSampleQuestions, hideSampleQuestions, true);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.UpdatedSpotterChatPrompt, updatedSpotterChatPrompt, true);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterSidebarDefaultExpanded, spotterSidebarDefaultExpanded, true);
        // String params
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterSidebarTitle, spotterSidebarTitle);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterChatRenameLabel, spotterChatRenameLabel);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterChatDeleteLabel, spotterChatDeleteLabel);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterDeleteConversationModalTitle, spotterDeleteConversationModalTitle);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterPastConversationAlertMessage, spotterPastConversationAlertMessage);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterBestPracticesLabel, spotterBestPracticesLabel);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterConversationsBatchSize, spotterConversationsBatchSize);
        (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.SpotterNewChatButtonTitle, spotterNewChatButtonTitle);
        // URL param with validation
        if (spotterDocumentationUrl !== undefined) {
            const [isValid, validationError] = (0, utils_1.validateHttpUrl)(spotterDocumentationUrl);
            if (isValid) {
                queryParams[types_1.Param.SpotterDocumentationUrl] = spotterDocumentationUrl;
            }
            else {
                this.handleError({
                    errorType: types_1.ErrorDetailsTypes.VALIDATION_ERROR,
                    message: errors_1.ERROR_MESSAGE.INVALID_SPOTTER_DOCUMENTATION_URL,
                    code: types_1.EmbedErrorCodes.INVALID_URL,
                    error: (validationError === null || validationError === void 0 ? void 0 : validationError.message) || errors_1.ERROR_MESSAGE.INVALID_SPOTTER_DOCUMENTATION_URL,
                });
            }
        }
        // Handle spotterChatConfig params
        if (spotterChatConfig) {
            const { hideToolResponseCardBranding, toolResponseCardBrandingLabel, } = spotterChatConfig;
            (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.HideToolResponseCardBranding, hideToolResponseCardBranding, true);
            (0, utils_1.setParamIfDefined)(queryParams, types_1.Param.ToolResponseCardBrandingLabel, toolResponseCardBrandingLabel);
        }
        return queryParams;
    }
    getIframeSrc() {
        const { worksheetId, searchOptions, runtimeFilters, excludeRuntimeFiltersfromURL, runtimeParameters, excludeRuntimeParametersfromURL, spotterSidebarConfig, } = this.viewConfig;
        const path = 'insights/conv-assist';
        const queryParams = this.getEmbedParamsObject();
        const enablePastConversationsSidebar = spotterSidebarConfig === null || spotterSidebarConfig === void 0 ? void 0 : spotterSidebarConfig.enablePastConversationsSidebar;
        if (!(0, isUndefined_1.default)(enablePastConversationsSidebar)) {
            queryParams[types_1.Param.EnablePastConversationsSidebar] = !!enablePastConversationsSidebar;
        }
        let query = '';
        const queryParamsString = (0, utils_1.getQueryParamString)(queryParams, true);
        if (queryParamsString) {
            query = `?${queryParamsString}`;
        }
        const filterQuery = (0, utils_1.getFilterQuery)(runtimeFilters || []);
        if (filterQuery && !excludeRuntimeFiltersfromURL) {
            query += `&${filterQuery}`;
        }
        const parameterQuery = (0, utils_1.getRuntimeParameters)(runtimeParameters || []);
        if (parameterQuery && !excludeRuntimeParametersfromURL) {
            query += `&${parameterQuery}`;
        }
        const tsPostHashParams = this.getThoughtSpotPostUrlParams({
            worksheet: worksheetId,
            query: (searchOptions === null || searchOptions === void 0 ? void 0 : searchOptions.searchQuery) || '',
        });
        return `${this.getEmbedBasePath(query)}/embed/${path}${tsPostHashParams}`;
    }
    async render() {
        await super.render();
        const src = this.getIframeSrc();
        await this.renderIFrame(src);
        return this;
    }
}
exports.SpotterEmbed = SpotterEmbed;
/**
 * Embed ThoughtSpot AI Conversation.
 * @deprecated from SDK: 1.39.0 | ThoughtSpot: 10.10.0.cl
 * Use {@link SpotterEmbed} instead
 * @group Embed components
 * @example
 * ```js
 * const conversation = new SpotterEmbed('#tsEmbed', {
 *   worksheetId: 'worksheetId',
 *   searchOptions: {
 *     searchQuery: 'searchQuery',
 *   },
 * });
 * conversation.render();
 * ```
 * @version SDK: 1.37.0 | ThoughtSpot: 10.9.0.cl
 */
class ConversationEmbed extends SpotterEmbed {
    constructor(container, viewConfig) {
        viewConfig = {
            embedComponentType: 'conversation',
            excludeRuntimeFiltersfromURL: true,
            excludeRuntimeParametersfromURL: true,
            ...viewConfig,
        };
        super(container, viewConfig);
        this.viewConfig = viewConfig;
    }
}
exports.ConversationEmbed = ConversationEmbed;
//# sourceMappingURL=conversation.js.map